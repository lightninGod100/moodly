-- Users table
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  country VARCHAR(100),
  test_user BOOLEAN DEFAULT FALSE,
  created_at BIGINT NOT NULL,
  created_at_utc TIMESTAMPTZ DEFAULT NOW(),
  profile_photo text,
  gender character varying(20),
  last_country_change_at bigint,
  mark_for_deletion bool,
 mark_for_deletion_at bigint,
username
);

-- Moods table
CREATE TABLE moods (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  mood VARCHAR(50) NOT NULL,
  created_at BIGINT NOT NULL,
  created_at_local TIMESTAMPTZ DEFAULT NOW(),
  day_view VARCHAR(20) NOT NULL,
  timezone VARCHAR(50) NOT NULL
);

--email-logs

CREATE TABLE contact_submissions (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,  -- Nullable for non-authenticated users (NULL = guest)
  subject VARCHAR(255) NOT NULL,                            -- Reason for contact
  body TEXT NOT NULL,                                       -- User's message
  email VARCHAR(255),                                       -- User's email (from form or DB)
  created_at_utc BIGINT NOT NULL,                          -- UNIX timestamp
  status VARCHAR(50) NOT NULL DEFAULT 'pending'            -- 'pending', 'sent', 'failed', 'processed'
);



CREATE TABLE user_activity_log (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,  -- Changed from CASCADE to SET NULL
    key VARCHAR(50) NOT NULL,
    value_timestamp BIGINT,           
    value_string TEXT,                
    created_at BIGINT NOT NULL,       
    created_at_utc TIMESTAMPTZ DEFAULT NOW()
);

-- Users table indexes (very fast with low data)
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);

-- Moods table indexes (still very fast with 500 rows)
CREATE INDEX idx_moods_user_id ON moods(user_id);
CREATE INDEX idx_moods_created_at ON moods(created_at);
CREATE INDEX idx_moods_user_time ON moods(user_id, created_at DESC);



CREATE TABLE refresh_tokens (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    token TEXT NOT NULL UNIQUE,
    device_id VARCHAR(255) NOT NULL,
    device_info JSONB,
    created_at BIGINT NOT NULL, -- Epoch timestamp in milliseconds
    expires_at BIGINT NOT NULL, -- Epoch timestamp in milliseconds
    last_used BIGINT, -- Epoch timestamp in milliseconds
    
    -- Ensure one token per device per user
    CONSTRAINT unique_user_device UNIQUE(user_id, device_id)
);


CREATE TABLE IF NOT EXISTS ai_insights_cache (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    insights_data JSONB NOT NULL,
    created_at BIGINT NOT NULL, -- Epoch time in milliseconds
    created_at_local TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
CREATE INDEX idx_ai_insights_user_created 
ON ai_insights_cache(user_id, created_at_local DESC);